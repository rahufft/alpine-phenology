---
title: "Alpine Phenology"
author: "RA Hufft"
date: "August 28, 2015"
output: word_document
---

`install.packages("RCurl")` if you want it
`install.packages("ggplot2")`   

#Try a `rm(list=ls())` before running

```{r}
library(RCurl)
library(ggplot2)
library(data.table)
```

Bring csv in from the website
I get an error: `Error in str.default(obj, ...) : invalid multibyte string 2` but will see if it matters...   
looks like it's the lat long that didn't get in correctly
```{r, echo=FALSE}
bloom<-read.csv(text = getURL("https://raw.githubusercontent.com/rahufft/alpine-phenology/master/QR_final_R_plant_climate_data.csv"))

head(bloom)
```

If not working to load from github:
```{r}
bloom<-read.csv(path.expand("P:/alpine-phenology/QR_final_R_plant_climate_data.csv"))

#Bring in Q/All.Projects_by_species/aa_Spapefiles_Maps/aa_QGIS Projects/AlpinePhenologyproject/

#bloom<-read.csv(path.expand("P:/alpine-phenology/TB_tempPrecipData.csv"),        
#                header = TRUE, as.is=TRUE)   
```

```{r}
#created new column that divides Raw_precip by 100 (see PRISM documentation) to get mm
head(bloom)
names(bloom)
str(bloom)  #tells me column name, data type and examples, errors in lat long when brought in from web

#Climate data figures
#This section runs linear regression on Avg High temp by Year
#hist(bloom$Avg_Hi)
plot(bloom$Year,bloom$Avg_Hi, main="Average High Temperature by Year",xlab="Year", ylab="Degrees Celsius")
abline(lm(bloom$Avg_Hi~bloom$Year))
summary(lm(bloom$Avg_Hi~bloom$Year))
#plot(lm(bloom$Avg_Hi~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```

```{r}
#This section runs linear regression on Avg Low temp by Year
#hist(bloom$Avg_Lo)
plot(bloom$Year,bloom$Avg_Lo, main="Average Low Temperature by Year",xlab="Year", ylab="Degrees Celsius")
abline(lm(bloom$Avg_Lo~bloom$Year))
summary(lm(bloom$Avg_Lo~bloom$Year))
#plot(lm(bloom$Avg_Lo~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```


```{r}

#This section runs linear regression on Precipitation by Year
hist(bloom$Raw_Precip)
plot(bloom$Year,bloom$Raw_Precip, main="Precipitation by Year",xlab="Year", ylab="Precipitation (mm)")
abline(lm(bloom$Raw_Precip~bloom$Year))
summary(lm(bloom$Raw_Precip~bloom$Year))
#plot(lm(bloom$Raw_Precip ~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```



#Graph just the significant spp by year to see how many days earlier for these species that are showing a signal by year
#re-run code that runs regressions on each species to create table to subset from
#Limit all data to after 1949, 7220 obs. from table (7217 obs. from query in Access)
```{r}

bl50 <- subset(bloom, bloom$year_plant > 1949) #Our dataset already has this subset but re-running as a double check

nrow(bl50)
nrow(subset(bloom, bloom$year_plant > 1949))

str(bl50)
head(bl50)
```


```{r}
 names <- unique(bl50$Scientific.Name)		# Names includes synonyms, sspListID contains unique taxa
 namesID <- unique(bl50$sppListID)
length(namesID)	# 290
head(namesID)
names(bl50)

#There are multiple bloom dates per year for many species. Want to narrow down to one, earliest, per year
table(bl50$sppListID, bl50$Year)

```


Don't worry about bloom vs. bl50, they are identical... and other checks    
```{r}
#bl50 and bloom are the same
identical(bl50, bloom)

#There should be 290 species
length(unique(bl50$sppListID))

#Only need some columns of bloom:bl50 for minimum julian dates
names(bl50[,c(4:5,11,19:26)])
```


Pull out the earliest bloom date per year per species
## Break up the function into gathering the earliest bloom day per year seperate from regression per species
## Earliest bloom date held in min.dates
Aggregate instead of apply?
Much faster and more corrector!
```{r}

minJul.dates <- lapply(unique(bl50$sppListID), function(x){
  this.species <- bl50[bl50$sppListID == x,c(4:5,11,19:26)]
  these.rows <- aggregate(startDayOfYear~Year, this.species, FUN=min)
  unique(merge(this.species, these.rows, by = c("startDayOfYear","Year")))
  })

names(minJul.dates) <- unique(bl50$sppListID)

head(minJul.dates[[219]])

min.dates <- do.call(rbind,minJul.dates)

table(min.dates$Year, min.dates$sppListID)

```


#Check that there is only one minimum date per year
```{r}
minpyear <- table(min.dates$Year, min.dates$sppListID)
mpy.df <- data.frame(minpyear)
mpy.df[mpy.df$Freq > 1,] #when we have ealiestBloomDate in the lapply, that's not unique so it picks a few duplicates, now fixed
```

```{r}
library(psych)
cor.plot(cor(min.dates[,-(1:4)]), numbers = TRUE)
# should keep Raw_Precip and Avg_Lo

cor(min.dates[,-(1:4)])

#getting a ggplot error of "Error in .Call.graphics(C_palette2, .Call(C_palette2, NULL)) : 
#  invalid graphics state"

#fix error by running dev.off()
dev.off()

```


ggplot option after subset to earliest observation per year per species    
Avg high temperature    
```{r}
ggplot(min.dates, aes(Year,Avg_Hi))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average High Temperature by Year")+
  xlab("Year")+
  ylab("Degrees Celsius")
```

```{r}
ggplot(min.dates, aes(Avg_Hi, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average High Temperature") +
  xlab("Degrees Celsius")+
  ylab("Julian Date")
```

Average low temperature
```{r}
ggplot(min.dates, aes(Year,Avg_Lo))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Low Temperature by Year")+
  xlab("Year")+
  ylab("Degrees Celsius")

```

```{r}
ggplot(min.dates, aes(Avg_Lo, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Low Temperature") +
  xlab("Degrees Celsius")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Avg_Lo, data = min.dates))
```





Average precipitation
```{r}
ggplot(min.dates, aes(Year,Raw_Precip))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Average Precipitation by Year")+
  xlab("Year")+
  ylab("Precipitation (mm)")


summary(lm(Raw_Precip~Year, data = min.dates))
```

```{r}
ggplot(min.dates, aes(Raw_Precip, startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Average Precipitation") +
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

summary(lm(startDayOfYear~Raw_Precip, data = min.dates))
```




### Minimum Julian bloom date by year
```{r}
ggplot(min.dates, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

 summary(lm(min.dates$startDayOfYear~min.dates$Year))
```
    
    
    
Graph of all spp data by year

```{r}
#bloom<-read.csv(path.expand("P:/alpine-phenology/QR_final_R_plant_climate_data.csv"),        
#                header = TRUE, as.is=TRUE)   
hist(min.dates$startDayOfYear)#need to log transform data

plot(min.dates$Year,min.dates$startDayOfYear, main="First Collection Date for All 
Species",xlab="Year", ylab="Julian Date")
abline(lm(min.dates$startDayOfYear~min.dates$Year))
summary(lm(min.dates$startDayOfYear~min.dates$Year)) 
#both intercept and slope significant. If include all data, the date of first collection is statistically earlier by 0.062563/year, or 3.75 days earlier over the course of the study period. 
#plot(lm(bloom$startDayOfYear ~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```



#Regression per species
#update regression loop to match pulling minimum dates above    
The variable can be set to which variable you want to use. Choose from "Year", "Raw_Precip", "Avg_Hi", or "Avg_Lo"...    

```{r}
JulBloomDate <- function(variable){
  namesID <- unique(min.dates$sppListID)
  
  #Which column number has the variable of interest
  colnum <- match(variable,names(min.dates))
  
  JYC <- lapply(namesID, function(x){
    blnew <- min.dates[min.dates$sppListID == x,]
    foo1 <- summary(lm(blnew$startDayOfYear~blnew[,colnum]))
    jul.yr.coef <- data.frame(cbind(data.frame(t(foo1$coefficients[2,])),
                                    foo1$coefficients[1,1],
                                    t(foo1$fstatistic),
                                    Species = blnew$Scientific.Name[1],
                                    foo1$adj.r.squared))
    })
  
  JYC <- do.call(rbind, JYC)
  colnames(JYC) <- c("Slope", "StErr", "t.value", "p.value", "Intercept", 
                   "F Stat", "numDF","denDF", "Species", "adj.r.squ")
  JYC
}
```


# "Year" regression per species    

```{r}
yr.bl <- JulBloomDate("Year")

head(yr.bl)
#subset that signficantchange over time
yr.sig <- yr.bl[yr.bl$p.value < 0.05,]

#merge the significant species with the min.dates species
yr.sig.min <- merge(yr.sig, min.dates, by.x = "Species", by.y = "Scientific.Name")


ggplot(yr.sig.min, aes(Year,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by Year")+
  xlab("Year")+
  ylab("Julian Date")

 summary(lm(yr.sig.min$startDayOfYear~yr.sig.min$Year))


nrow(yr.sig) #53 species
nrow(yr.sig[yr.sig$Slope > 0,]) # no species have later bloom dates over time
nrow(yr.sig[yr.sig$adj.r.squ > 0.25,]) # 18 species have adj.r.squares over 0.25
yr.sig[yr.sig$adj.r.squ > 0.25,]


```



# "Raw_Precip" regression per species    

```{r}
precip.bl <- JulBloomDate("Raw_Precip")

head(yr.bl)
#subset that signficant change by precipitation
precip.sig <- precip.bl[precip.bl$p.value < 0.05,]

#merge the significant species with the min.dates species
precip.sig.min <- merge(precip.sig, min.dates, by.x = "Species", by.y = "Scientific.Name")


ggplot(precip.sig.min, aes(Raw_Precip,startDayOfYear))+
  geom_point()+
  stat_smooth(method="lm")+
  theme_bw()+
  labs(title="Earliest Bloom Date by precipitation")+
  xlab("Precipitation (mm)")+
  ylab("Julian Date")

 summary(lm(precip.sig.min$startDayOfYear~precip.sig.min$Year))



```


########## Columns that you can use to compare to earliest bloom date (taken from "startDayOfYear")
              
#[11] "startDayOfYear"   [20] "Raw_Precip"                 
#[21] "Avg_Hi"                "Med_Hi"                      
#[23] "Avg_Lo"                "Med_Lo"                       
#[25] "Av_Temp"               "Med_Temp"       



















```{r}
#merge two tables
merge(stats, bloom, by = intersect(names(x), names(y)),
      by.x = by, by.y = by, all = FALSE, all.x = all, all.y = all,
      sort = TRUE, suffixes = c(".x",".y"),
      incomparables = NULL, ...)

hist(bloom$startDayOfYear)
plot(bloom$Year,bloom$startDayOfYear, main="First Collection Date for All Species",xlab="Year", ylab="Julian Date")
abline(lm(bloom$startDayOfYear~bloom$Year))
summary(lm(bloom$startDayOfYear~bloom$Year))
#plot(lm(bloom$startDayOfYear ~bloom$Year)) #check residuals for heteroscedasticity and nonlinearity
```





